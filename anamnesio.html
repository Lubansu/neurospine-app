<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anamnèsio - Questionnaire de préadmission</title>
    <!-- Intégration de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Reset et styles de base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.5;
        }
        
        /* Conteneur principal */
        #app {
            max-width: 100%;
            width: 100%;
            min-height: 100vh;
            margin: 0 auto;
            background-color: #fff;
            position: relative;
            overflow: hidden;
        }
        
        /* Écran d'accueil */
        .home-screen {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: linear-gradient(to bottom, #f0f6ff 0%, #ffffff 100%);
            padding: 2rem;
            text-align: center;
        }
        
        .home-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 450px;
            margin: 0 auto;
            width: 100%;
        }
        
        .app-title {
            color: #1a49b0;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .app-subtitle {
            color: #556580;
            font-size: 1.25rem;
            margin-bottom: 2.5rem;
        }
        
        .home-description {
            color: #4b5563;
            font-size: 1.1rem;
            margin-bottom: 2.5rem;
            padding: 0 1rem;
        }
        
        /* Boutons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 500;
            font-size: 1.1rem;
            border: none;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background-color: #245ae3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1a49b0;
        }
        
        .btn-outline {
            background-color: white;
            color: #245ae3;
            border: 1px solid #c5d4f3;
        }
        
        .btn-outline:hover {
            background-color: #f0f6ff;
        }
        
        .btn i {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }
        
        .footer-text {
            color: #6b7280;
            font-size: 0.75rem;
            margin-top: 1.5rem;
            padding: 0 1.5rem;
        }
        
        /* Écrans de questionnaire */
        .screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            background-color: #fff;
        }
        
        .header {
            background-color: #245ae3;
            color: white;
            padding: 1rem;
            position: relative;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .question-counter {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin-top: 0.75rem;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: white;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .question-container {
            flex-grow: 1;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        
        .question {
            font-size: 1.25rem;
            color: #334155;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .question-hint {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 1.5rem;
        }
        
        /* Mode vocal */
        .voice-answer-container {
            background-color: #f5f7fa;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
        }
        
        .voice-answer-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .voice-answer {
            color: #334155;
        }
        
        .mic-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .mic-button {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #245ae3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 10px 15px -3px rgba(36, 90, 227, 0.3);
        }
        
        .mic-icon {
            font-size: 2rem;
        }
        
        .mic-label {
            margin-top: 1rem;
            color: #6b7280;
            font-size: 0.95rem;
        }
        
        .recording {
            background-color: #ef4444;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
        
        .voice-actions {
            display: none;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .confirm-btn {
            padding: 0.75rem 1.5rem;
            background-color: #22c55e;
            color: white;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            border: none;
            font-weight: 500;
        }
        
        .retry-btn {
            padding: 0.75rem 1.5rem;
            background-color: #f3f4f6;
            color: #374151;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            border: none;
            font-weight: 500;
        }
        
        .btn-icon {
            margin-right: 0.5rem;
        }
        
        /* Mode texte */
        .text-form {
            width: 100%;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.25rem;
        }
        
        .form-label {
            display: block;
            color: #334155;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }
        
        .text-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
        }
        
        .text-input:focus {
            outline: none;
            border-color: #245ae3;
            box-shadow: 0 0 0 2px rgba(36, 90, 227, 0.2);
        }
        
        .textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .radio-group {
            display: flex;
            gap: 1rem;
        }
        
        .radio-button {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .radio-selected-yes {
            border-color: #22c55e;
            background-color: #f0fdf4;
            color: #16a34a;
        }
        
        .radio-selected-no {
            border-color: #ef4444;
            background-color: #fef2f2;
            color: #dc2626;
        }
        
        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        
        .checkbox-item:hover {
            background-color: #f3f4f6;
        }
        
        .checkbox-input {
            margin-right: 0.5rem;
            width: 1.25rem;
            height: 1.25rem;
            accent-color: #245ae3;
        }
        
        /* Navigation */
        .navigation {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
        }
        
        .nav-button {
            padding: 0.75rem 1.25rem;
            border: none;
            background-color: transparent;
            color: #245ae3;
            font-weight: 500;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-radius: 0.5rem;
        }
        
        .nav-button:hover {
            background-color: #f0f6ff;
        }
        
        .nav-button:disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        .nav-button:disabled:hover {
            background-color: transparent;
        }
        
        .prev-icon {
            margin-right: 0.5rem;
        }
        
        .next-icon {
            margin-left: 0.5rem;
        }
        
        /* Écran de résumé */
        .summary-header {
            background-color: #245ae3;
            color: white;
            padding: 1rem;
        }
        
        .summary-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .summary-subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .summary-container {
            flex-grow: 1;
            padding: 1.5rem;
            overflow: auto;
        }
        
        .summary-success {
            background-color: #f0f6ff;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
        }
        
        .success-icon {
            color: #245ae3;
            margin-right: 0.75rem;
            margin-top: 0.25rem;
            font-size: 1.25rem;
        }
        
        .success-content h3 {
            color: #245ae3;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .success-content p {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .summary-section {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .section-header {
            background-color: #f8fafc;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: #334155;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .section-body {
            padding: 1rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .section-body.active {
            max-height: 500px;
        }
        
        .qa-item {
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .qa-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .qa-question {
            font-weight: 500;
            font-size: 0.9rem;
            color: #334155;
            margin-bottom: 0.25rem;
        }
        
        .qa-answer {
            color: #4b5563;
        }
        
        .summary-actions {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .download-btn {
            width: 100%;
            background-color: #245ae3;
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        
        .download-icon {
            margin-right: 0.5rem;
        }
        
        /* Alertes et notifications */
        .alert {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #b91c1c;
            padding: 0.75rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
        }
        
        .info-message {
            background-color: #eff6ff;
            padding: 0.75rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s forwards;
        }
        
        .slide-in {
            animation: slideIn 0.3s forwards;
        }
        
        .slide-out {
            animation: slideOut 0.3s forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-50px); }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Écran d'accueil -->
        <div id="home-screen" class="home-screen">
            <div class="home-content">
                <h1 class="app-title">Anamnèsio</h1>
                <p class="app-subtitle">Questionnaire de préadmission</p>
                
                <p class="home-description">
                    Choisissez comment vous souhaitez remplir votre questionnaire de préadmission
                </p>
                
                <button 
                    onclick="startQuestionnaire('voice')"
                    class="btn btn-primary"
                >
                    <i class="fas fa-microphone"></i>
                    Mode vocal (recommandé)
                </button>
                
                <button 
                    onclick="startQuestionnaire('text')"
                    class="btn btn-outline"
                >
                    <i class="fas fa-keyboard"></i>
                    Mode texte
                </button>
                
                <p class="footer-text">
                    Vos données sont confidentielles et sécurisées. Elles seront partagées uniquement avec votre établissement de santé.
                </p>
            </div>
        </div>

        <!-- Mode vocal - écran de question -->
        <div id="voice-screen" class="screen">
            <div class="header">
                <div class="header-content">
                    <h2 id="voice-section-title" class="section-title">Section</h2>
                    <span id="voice-question-counter" class="question-counter">Question 1/5</span>
                </div>
                
                <!-- Barre de progression -->
                <div class="progress-bar">
                    <div id="voice-progress-bar" class="progress" style="width: 20%"></div>
                </div>
            </div>
            
            <!-- Contenu de la question -->
            <div class="question-container">
                <!-- Alertes et messages -->
                <div id="voice-error" class="alert"></div>
                <div id="voice-info" class="info-message"></div>
                
                <h3 id="voice-question-text" class="question">Question</h3>
                <p id="voice-recording-status" class="question-hint">
                    Appuyez sur le micro et parlez
                </p>
                
                <!-- Réponse reconnue -->
                <div id="voice-answer-container" class="voice-answer-container">
                    <p class="voice-answer-label">Votre réponse :</p>
                    <p id="voice-answer" class="voice-answer"></p>
                </div>
                
                <!-- Bouton microphone -->
                <div class="mic-container">
                    <button
                        id="mic-button"
                        onclick="toggleVoiceRecording()"
                        class="mic-button"
                    >
                        <i id="mic-icon" class="fas fa-microphone mic-icon"></i>
                    </button>
                    <p id="mic-label" class="mic-label">
                        Appuyez pour dicter votre réponse
                    </p>
                </div>
                
                <!-- Actions après reconnaissance -->
                <div id="voice-actions" class="voice-actions">
                    <button onclick="confirmVoiceAnswer()" class="confirm-btn">
                        <i class="fas fa-check btn-icon"></i> Confirmer
                    </button>
                    <button onclick="resetVoiceRecognition()" class="retry-btn">
                        <i class="fas fa-redo btn-icon"></i> Recommencer
                    </button>
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="navigation">
                <button 
                    onclick="previousQuestion()"
                    id="voice-prev-button"
                    class="nav-button"
                    disabled
                >
                    <i class="fas fa-chevron-left prev-icon"></i>
                    Précédent
                </button>
                
                <button
                    onclick="skipQuestion()"
                    class="nav-button"
                >
                    Suivant
                    <i class="fas fa-chevron-right next-icon"></i>
                </button>
            </div>
        </div>

        <!-- Mode texte - écran de section -->
        <div id="text-screen" class="screen">
            <div class="header">
                <div class="header-content">
                    <h2 id="text-section-title" class="section-title">Section</h2>
                    <span id="text-section-counter" class="question-counter">Section 1/3</span>
                </div>
                
                <!-- Barre de progression -->
                <div class="progress-bar">
                    <div id="text-progress-bar" class="progress" style="width: 33%"></div>
                </div>
            </div>
            
            <!-- Questions de la section -->
            <div class="question-container">
                <div id="text-questions-container" class="text-form">
                    <!-- Les questions seront insérées ici dynamiquement -->
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="navigation">
                <button 
                    onclick="previousSection()"
                    id="text-prev-button"
                    class="nav-button"
                    disabled
                >
                    <i class="fas fa-chevron-left prev-icon"></i>
                    Section précédente
                </button>
                
                <button
                    onclick="nextSection()"
                    id="text-next-button"
                    class="nav-button"
                >
                    Section suivante
                    <i class="fas fa-chevron-right next-icon"></i>
                </button>
            </div>
        </div>

        <!-- Écran de résumé -->
        <div id="summary-screen" class="screen">
            <div class="summary-header">
                <h2 class="summary-title">Résumé du questionnaire</h2>
                <p class="summary-subtitle">Vérifiez vos informations avant de les soumettre</p>
            </div>
            
            <!-- Contenu du résumé -->
            <div class="summary-container">
                <div class="summary-success">
                    <i class="fas fa-file-medical success-icon"></i>
                    <div class="success-content">
                        <h3>Questionnaire complété avec succès</h3>
                        <p>Vous pouvez maintenant vérifier vos réponses.</p>
                    </div>
                </div>
                
                <!-- Sections du résumé -->
                <div id="summary-content">
                    <!-- Le contenu du résumé sera inséré ici dynamiquement -->
                </div>
            </div>
            
            <!-- Actions -->
            <div class="summary-actions">
                <button 
                    onclick="generatePDF()"
                    class="download-btn"
                >
                    <i class="fas fa-download download-icon"></i>
                    Télécharger le résumé PDF
                </button>
                <p class="footer-text" style="text-align:center; margin-top:1rem;">
                    En conditions réelles, ces informations seraient transmises à votre établissement de santé.
                </p>
            </div>
        </div>
    </div>

    <!-- Script pour la fonctionnalité du prototype -->
    <script>
        // Structure du questionnaire
        const questionnaire = [
            {
                id: "pathologie",
                title: "Pathologie et informations",
                questions: [
                    {
                        id: "pathologie_operation",
                        question: "Pour quelle pathologie ou opération êtes-vous admis(e) ?",
                        type: "text",
                        placeholder: "Ex: Appendicite, Fracture du fémur..."
                    },
                    {
                        id: "attentes_admission",
                        question: "Qu'attendez-vous de votre admission ?",
                        type: "text",
                        placeholder: "Ex: Soulagement de la douleur, guérison..."
                    },
                    {
                        id: "informations_supplementaires",
                        question: "Y a-t-il des informations relatives à votre traitement ou intervention en cours ?",
                        type: "text",
                        placeholder: "Ex: Affections physiques ou mentales, médicaments..."
                    }
                ]
            },
            {
                id: "donnees_physiques",
                title: "Données physiques",
                questions: [
                    {
                        id: "age",
                        question: "Quel est votre âge ?",
                        type: "number",
                        placeholder: "Ex: 45"
                    },
                    {
                        id: "poids",
                        question: "Quel est votre poids en kilogrammes ?",
                        type: "number",
                        placeholder: "Ex: 70"
                    },
                    {
                        id: "taille",
                        question: "Quelle est votre taille en mètres ?",
                        type: "number",
                        placeholder: "Ex: 1.75"
                    },
                    {
                        id: "tension",
                        question: "Quelle est votre tension artérielle (si connue) ?",
                        type: "text",
                        placeholder: "Ex: 120/80"
                    },
                    {
                        id: "groupe_sanguin",
                        question: "Quel est votre groupe sanguin (si connu) ?",
                        type: "text",
                        placeholder: "Ex: A+, O-, ..."
                    }
                ]
            },
            {
                id: "allergies",
                title: "Allergies",
                questions: [
                    {
                        id: "allergie_presence",
                        question: "Avez-vous des allergies connues ?",
                        type: "boolean"
                    },
                    {
                        id: "allergie_types",
                        question: "À quelles substances êtes-vous allergique ?",
                        type: "multiselect",
                        options: [
                            "Pénicilline/antibiotiques",
                            "Analgésiques/AINS",
                            "Substances anesthésiques locales",
                            "Iode",
                            "Latex/caoutchouc",
                            "Aliments",
                            "Sparadrap",
                            "Nickel (bijoux factices)",
                            "Produits de contraste",
                            "Autre"
                        ],
                        conditional: "allergie_presence", // Cette question n'apparaît que si allergie_presence = true
                        conditionalValue: true
                    },
                    {
                        id: "allergie_reaction",
                        question: "Quel type de réaction avez-vous eue ?",
                        type: "multiselect",
                        options: [
                            "Évanouissement (faible tension artérielle)",
                            "Gonflement autour de la bouche",
                            "Essoufflement",
                            "Respiration sifflante",
                            "Taches rouges sur la peau avec gonflement",
                            "Taches rouges sur la peau avec démangeaisons",
                            "Fièvre",
                            "Autre"
                        ],
                        conditional: "allergie_presence",
                        conditionalValue: true
                    }
                ]
            },
            {
                id: "antecedents",
                title: "Antécédents médicaux",
                questions: [
                    {
                        id: "operations_precedentes",
                        question: "Avez-vous déjà subi des opérations chirurgicales ?",
                        type: "boolean"
                    },
                    {
                        id: "operations_details",
                        question: "Précisez les opérations et les dates (approximatives)",
                        type: "text",
                        placeholder: "Ex: Appendicectomie en 2010, ...",
                        conditional: "operations_precedentes",
                        conditionalValue: true
                    },
                    {
                        id: "maladies_chroniques",
                        question: "Souffrez-vous de maladies chroniques ?",
                        type: "boolean"
                    },
                    {
                        id: "maladies_details",
                        question: "Précisez les maladies chroniques dont vous souffrez",
                        type: "text",
                        placeholder: "Ex: Diabète, hypertension, asthme...",
                        conditional: "maladies_chroniques",
                        conditionalValue: true
                    }
                ]
            },
            {
                id: "medicaments",
                title: "Médicaments actuels",
                questions: [
                    {
                        id: "prise_medicaments",
                        question: "Prenez-vous actuellement des médicaments ?",
                        type: "boolean"
                    },
                    {
                        id: "medicaments_liste",
                        question: "Listez les médicaments que vous prenez actuellement",
                        type: "text",
                        placeholder: "Ex: Paracétamol 1g, Lévothyrox 100µg...",
                        conditional: "prise_medicaments",
                        conditionalValue: true
                    },
                    {
                        id: "automedicaments",
                        question: "Prenez-vous des médicaments en automédication (sans ordonnance) ?",
                        type: "boolean"
                    },
                    {
                        id: "automedicaments_liste",
                        question: "Listez les médicaments que vous prenez en automédication",
                        type: "text",
                        placeholder: "Ex: Aspirine, ibuprofène, vitamines...",
                        conditional: "automedicaments",
                        conditionalValue: true
                    }
                ]
            }
        ];

        // Variables d'état
        let currentMode = null;
        let currentSection = 0;
        let currentQuestion = 0;
        let isRecording = false;
        let recognition = null;
        let answers = {};
        
        // Charger les réponses sauvegardées, si elles existent
        window.onload = function() {
            const savedAnswers = localStorage.getItem('anamnesio_answers');
            if (savedAnswers) {
                answers = JSON.parse(savedAnswers);
            }
        };
        
        // Initialisation de la reconnaissance vocale
        function initSpeechRecognition() {
            // Vérifier si la reconnaissance vocale est supportée
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
            } else if ('SpeechRecognition' in window) {
                recognition = new SpeechRecognition();
            } else {
                // La reconnaissance vocale n'est pas supportée
                showVoiceError("Votre navigateur ne supporte pas la reconnaissance vocale. Veuillez utiliser le mode texte.");
                return false;
            }
            
            // Configuration
            recognition.lang = 'fr-FR';
            recognition.continuous = false;
            recognition.interimResults = true;
            
            // Événements
            recognition.onresult = function(event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }
                
                if (finalTranscript) {
                    document.getElementById('voice-answer').textContent = finalTranscript;
                    document.getElementById('voice-answer-container').style.display = 'block';
                    document.getElementById('voice-actions').style.display = 'flex';
                }
            };
            
            recognition.onaudiostart = function() {
                // La capture audio a commencé
                showVoiceInfo("Écoutant... Parlez maintenant");
            };
            
            recognition.onend = function() {
                isRecording = false;
                updateRecordingUI(false);
                hideVoiceInfo();
            };
            
            recognition.onerror = function(event) {
                isRecording = false;
                updateRecordingUI(false);
                
                let errorMessage = "";
                switch(event.error) {
                    case 'not-allowed':
                        errorMessage = "Accès au microphone refusé. Veuillez autoriser l'accès dans les paramètres de votre navigateur.";
                        break;
                    case 'no-speech':
                        errorMessage = "Aucune parole détectée. Veuillez réessayer.";
                        break;
                    case 'network':
                        errorMessage = "Erreur réseau. Vérifiez votre connexion Internet.";
                        break;
                    default:
                        errorMessage = "Erreur de reconnaissance vocale. Veuillez réessayer.";
                }
                
                showVoiceError(errorMessage);
            };
            
            return true;
        }
        
        function showVoiceError(message) {
            const errorElement = document.getElementById('voice-error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // Cache automatiquement l'erreur après 5 secondes
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
        
        function showVoiceInfo(message) {
            const infoElement = document.getElementById('voice-info');
            infoElement.textContent = message;
            infoElement.style.display = 'block';
        }
        
        function hideVoiceInfo() {
            document.getElementById('voice-info').style.display = 'none';
        }
        
        // UI pour l'état d'enregistrement
        function updateRecordingUI(recording) {
            const micButton = document.getElementById('mic-button');
            const micIcon = document.getElementById('mic-icon');
            const micLabel = document.getElementById('mic-label');
            const recordingStatus = document.getElementById('voice-recording-status');
            
            if (recording) {
                micButton.classList.add('recording');
                micIcon.classList.remove('fa-microphone');
                micIcon.classList.add('fa-microphone-slash');
                micLabel.textContent = "Appuyez pour arrêter l'enregistrement";
                recordingStatus.textContent = "Écoutant... Parlez maintenant";
            } else {
                micButton.classList.remove('recording');
                micIcon.classList.add('fa-microphone');
                micIcon.classList.remove('fa-microphone-slash');
                micLabel.textContent = "Appuyez pour dicter votre réponse";
                recordingStatus.textContent = "Appuyez sur le micro et parlez";
            }
        }
        
        // Démarrer le questionnaire
        function startQuestionnaire(mode) {
            currentMode = mode;
            document.getElementById('home-screen').style.display = 'none';
            
            if (mode === 'voice') {
                if (!initSpeechRecognition() && recognition === null) {
                    // Basculer vers le mode texte si la reconnaissance vocale n'est pas disponible
                    startQuestionnaire('text');
                    return;
                }
                
                document.getElementById('voice-screen').style.display = 'flex';
                updateVoiceQuestion();
            } else {
                document.getElementById('text-screen').style.display = 'flex';
                updateTextSection();
            }
        }
        
        // Mise à jour de la question en mode vocal
        function updateVoiceQuestion() {
            const section = questionnaire[currentSection];
            const question = section.questions[currentQuestion];
            
            // Vérifier si c'est une question conditionnelle
            if (question.conditional && answers[question.conditional] !== question.conditionalValue) {
                // Passer à la question suivante si la condition n'est pas remplie
                nextQuestion();
                return;
            }
            
            document.getElementById('voice-section-title').textContent = section.title;
            document.getElementById('voice-question-text').textContent = question.question;
            document.getElementById('voice-question-counter').textContent = `Question ${currentQuestion + 1}/${section.questions.length}`;
            
            // Mettre à jour la barre de progression
            const totalQuestions = getTotalQuestions();
            const questionIndex = getCurrentQuestionIndex();
            const progressPercentage = (questionIndex / totalQuestions) * 100;
            document.getElementById('voice-progress-bar').style.width = `${progressPercentage}%`;
            
            // Réinitialiser l'interface
            document.getElementById('voice-answer').textContent = '';
            document.getElementById('voice-answer-container').style.display = 'none';
            document.getElementById('voice-actions').style.display = 'none';
            document.getElementById('voice-error').style.display = 'none';
            document.getElementById('voice-info').style.display = 'none';
            
            // Désactiver le bouton précédent s'il s'agit de la première question
            const prevButton = document.getElementById('voice-prev-button');
            if (currentSection === 0 && currentQuestion === 0) {
                prevButton.disabled = true;
            } else {
                prevButton.disabled = false;
            }
        }
        
        // Mise à jour de la section en mode texte
        function updateTextSection() {
            const section = questionnaire[currentSection];
            document.getElementById('text-section-title').textContent = section.title;
            document.getElementById('text-section-counter').textContent = `Section ${currentSection + 1}/${questionnaire.length}`;
            
            // Mettre à jour la barre de progression
            const progressPercentage = ((currentSection + 1) / questionnaire.length) * 100;
            document.getElementById('text-progress-bar').style.width = `${progressPercentage}%`;
            
            // Générer les questions
            const questionsContainer = document.getElementById('text-questions-container');
            questionsContainer.innerHTML = '';
            
            section.questions.forEach((question, index) => {
                // Vérifier si c'est une question conditionnelle
                if (question.conditional && answers[question.conditional] !== question.conditionalValue) {
                    return; // Ne pas afficher cette question
                }
                
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const label = document.createElement('label');
                label.className = 'form-label';
                label.textContent = question.question;
                formGroup.appendChild(label);
                
                if (question.type === 'text') {
                    const textarea = document.createElement('textarea');
                    textarea.className = 'text-input textarea';
                    textarea.placeholder = question.placeholder || "Tapez votre réponse ici...";
                    textarea.value = answers[question.id] || '';
                    textarea.oninput = function() { saveAnswer(question.id, this.value); };
                    formGroup.appendChild(textarea);
                } 
                else if (question.type === 'number') {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'text-input';
                    input.placeholder = question.placeholder || "Entrez une valeur numérique";
                    input.value = answers[question.id] || '';
                    input.oninput = function() { saveAnswer(question.id, this.value); };
                    formGroup.appendChild(input);
                } 
                else if (question.type === 'boolean') {
                    const radioGroup = document.createElement('div');
                    radioGroup.className = 'radio-group';
                    
                    const buttonYes = document.createElement('button');
                    buttonYes.type = 'button';
                    buttonYes.className = `radio-button ${answers[question.id] === true ? 'radio-selected-yes' : ''}`;
                    buttonYes.innerHTML = '<i class="fas fa-check btn-icon"></i> Oui';
                    buttonYes.onclick = function() { saveAnswer(question.id, true); updateTextSection(); };
                    
                    const buttonNo = document.createElement('button');
                    buttonNo.type = 'button';
                    buttonNo.className = `radio-button ${answers[question.id] === false ? 'radio-selected-no' : ''}`;
                    buttonNo.innerHTML = '<i class="fas fa-times btn-icon"></i> Non';
                    buttonNo.onclick = function() { saveAnswer(question.id, false); updateTextSection(); };
                    
                    radioGroup.appendChild(buttonYes);
                    radioGroup.appendChild(buttonNo);
                    formGroup.appendChild(radioGroup);
                } 
                else if (question.type === 'multiselect') {
                    const checkboxList = document.createElement('div');
                    checkboxList.className = 'checkbox-list';
                    
                    question.options.forEach(option => {
                        const selectedOptions = answers[question.id] || [];
                        const isSelected = selectedOptions.includes(option);
                        
                        const checkboxItem = document.createElement('div');
                        checkboxItem.className = `checkbox-item ${isSelected ? 'checkbox-selected' : ''}`;
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'checkbox-input';
                        checkbox.id = `${question.id}-${option}`;
                        checkbox.checked = isSelected;
                        checkbox.onchange = function() { 
                            toggleMultiSelect(question.id, option); 
                            updateTextSection();
                        };
                        
                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.htmlFor = `${question.id}-${option}`;
                        checkboxLabel.textContent = option;
                        
                        checkboxItem.appendChild(checkbox);
                        checkboxItem.appendChild(checkboxLabel);
                        checkboxList.appendChild(checkboxItem);
                    });
                    
                    formGroup.appendChild(checkboxList);
                }
                
                questionsContainer.appendChild(formGroup);
            });
            
            // Désactiver le bouton précédent s'il s'agit de la première section
            const prevButton = document.getElementById('text-prev-button');
            if (currentSection === 0) {
                prevButton.disabled = true;
            } else {
                prevButton.disabled = false;
            }
            
            // Changement du texte du bouton suivant pour la dernière section
            const nextButton = document.getElementById('text-next-button');
            if (currentSection === questionnaire.length - 1) {
                nextButton.innerHTML = 'Terminer <i class="fas fa-check next-icon"></i>';
            } else {
                nextButton.innerHTML = 'Section suivante <i class="fas fa-chevron-right next-icon"></i>';
            }
        }
        
        // Fonctions de navigation
        function nextQuestion() {
            const section = questionnaire[currentSection];
            
            if (currentQuestion < section.questions.length - 1) {
                currentQuestion++;
                updateVoiceQuestion();
            } else if (currentSection < questionnaire.length - 1) {
                currentSection++;
                currentQuestion = 0;
                updateVoiceQuestion();
            } else {
                showSummary();
            }
        }
        
        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                updateVoiceQuestion();
            } else if (currentSection > 0) {
                currentSection--;
                currentQuestion = questionnaire[currentSection].questions.length - 1;
                updateVoiceQuestion();
            }
        }
        
        function nextSection() {
            if (currentSection < questionnaire.length - 1) {
                currentSection++;
                updateTextSection();
            } else {
                showSummary();
            }
        }
        
        function previousSection() {
            if (currentSection > 0) {
                currentSection--;
                updateTextSection();
            }
        }
        
        // Fonctions pour le mode vocal
        function toggleVoiceRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        
        function startRecording() {
            if (!recognition) {
                showVoiceError("La reconnaissance vocale n'est pas disponible sur votre appareil");
                return;
            }
            
            isRecording = true;
            updateRecordingUI(true);
            
            try {
                recognition.start();
                showVoiceInfo("Écoutant... Parlez maintenant");
            } catch (e) {
                console.error("Erreur lors du démarrage de la reconnaissance:", e);
                isRecording = false;
                updateRecordingUI(false);
                showVoiceError("Erreur lors du démarrage de la reconnaissance vocale. Veuillez réessayer.");
            }
        }
        
        function stopRecording() {
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.error("Erreur lors de l'arrêt de la reconnaissance:", e);
                }
            }
            isRecording = false;
            updateRecordingUI(false);
            hideVoiceInfo();
        }
        
        function confirmVoiceAnswer() {
            const text = document.getElementById('voice-answer').textContent;
            const question = questionnaire[currentSection].questions[currentQuestion];
            
            // Traiter la réponse selon le type de question
            if (question.type === 'boolean') {
                // Convertir le texte en booléen
                const lowerText = text.toLowerCase();
                let boolValue = null;
                
                if (lowerText.includes('oui') || lowerText.includes('yes') || lowerText.includes('vrai') || lowerText === 'ok') {
                    boolValue = true;
                } else if (lowerText.includes('non') || lowerText.includes('no') || lowerText.includes('faux')) {
                    boolValue = false;
                }
                
                if (boolValue !== null) {
                    saveAnswer(question.id, boolValue);
                    nextQuestion();
                } else {
                    showVoiceError("Veuillez répondre par Oui ou Non");
                }
            } else if (question.type === 'multiselect') {
                // Traiter la sélection multiple
                const options = text.split(/et|,|\s+/).filter(Boolean);
                const matchedOptions = [];
                
                question.options.forEach(option => {
                    if (options.some(userOption => option.toLowerCase().includes(userOption.toLowerCase()) || userOption.toLowerCase().includes(option.toLowerCase()))) {
                        matchedOptions.push(option);
                    }
                });
                
                saveAnswer(question.id, matchedOptions);
                nextQuestion();
            } else {
                saveAnswer(question.id, text);
                nextQuestion();
            }
        }
        
        function resetVoiceRecognition() {
            document.getElementById('voice-answer').textContent = '';
            document.getElementById('voice-answer-container').style.display = 'none';
            document.getElementById('voice-actions').style.display = 'none';
        }
        
        function skipQuestion() {
            nextQuestion();
        }
        
        // Utilitaires
        function saveAnswer(questionId, value) {
            answers[questionId] = value;
            localStorage.setItem('anamnesio_answers', JSON.stringify(answers));
        }
        
        function toggleMultiSelect(questionId, option) {
            const currentSelections = answers[questionId] || [];
            
            if (currentSelections.includes(option)) {
                saveAnswer(questionId, currentSelections.filter(item => item !== option));
            } else {
                saveAnswer(questionId, [...currentSelections, option]);
            }
        }
        
        function getTotalQuestions() {
            return questionnaire.reduce((total, section) => {
                return total + section.questions.filter(q => {
                    // Ne pas compter les questions conditionnelles qui ne sont pas affichées
                    if (q.conditional && answers[q.conditional] !== q.conditionalValue) {
                        return false;
                    }
                    return true;
                }).length;
            }, 0);
        }
        
        function getCurrentQuestionIndex() {
            let index = 0;
            for (let i = 0; i < currentSection; i++) {
                index += questionnaire[i].questions.filter(q => {
                    // Ne pas compter les questions conditionnelles qui ne sont pas affichées
                    if (q.conditional && answers[q.conditional] !== q.conditionalValue) {
                        return false;
                    }
                    return true;
                }).length;
            }
            
            // Ajouter les questions de la section courante jusqu'à la question courante
            for (let i = 0; i < currentQuestion; i++) {
                const q = questionnaire[currentSection].questions[i];
                if (!q.conditional || answers[q.conditional] === q.conditionalValue) {
                    index++;
                }
            }
            
            return index;
        }
        
        // Montrer le résumé
        function showSummary() {
            // Masquer les écrans de questionnaire
            document.getElementById('voice-screen').style.display = 'none';
            document.getElementById('text-screen').style.display = 'none';
            
            // Afficher l'écran de résumé
            document.getElementById('summary-screen').style.display = 'flex';
            
            // Générer le contenu du résumé
            const summaryContent = document.getElementById('summary-content');
            summaryContent.innerHTML = '';
            
            questionnaire.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'summary-section';
                
                // En-tête de section
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header';
                sectionHeader.innerHTML = `
                    <h3>${section.title}</h3>
                    <i class="fas fa-chevron-down"></i>
                `;
                sectionDiv.appendChild(sectionHeader);
                
                // Contenu de la section
                const sectionBody = document.createElement('div');
                sectionBody.className = 'section-body';
                
                let hasAnswers = false;
                
                section.questions.forEach(question => {
                    // Ne pas inclure les questions conditionnelles qui ne sont pas affichées
                    if (question.conditional && answers[question.conditional] !== question.conditionalValue) {
                        return;
                    }
                    
                    if (answers[question.id] !== undefined) {
                        hasAnswers = true;
                        
                        const qaItem = document.createElement('div');
                        qaItem.className = 'qa-item';
                        
                        // Question
                        const qaQuestion = document.createElement('p');
                        qaQuestion.className = 'qa-question';
                        qaQuestion.textContent = question.question;
                        qaItem.appendChild(qaQuestion);
                        
                        // Réponse
                        const qaAnswer = document.createElement('p');
                        qaAnswer.className = 'qa-answer';
                        
                        if (question.type === 'boolean') {
                            qaAnswer.textContent = answers[question.id] ? 'Oui' : 'Non';
                        } else if (question.type === 'multiselect') {
                            const selectedOptions = answers[question.id] || [];
                            qaAnswer.textContent = selectedOptions.length > 0 
                                ? selectedOptions.join(', ') 
                                : "[Aucune sélection]";
                        } else {
                            qaAnswer.textContent = answers[question.id] || "[Non renseigné]";
                        }
                        
                        qaItem.appendChild(qaAnswer);
                        sectionBody.appendChild(qaItem);
                    }
                });
                
                if (hasAnswers) {
                    sectionDiv.appendChild(sectionBody);
                    summaryContent.appendChild(sectionDiv);
                }
            });
            
            // Ajouter des événements pour ouvrir/fermer les sections
            const sectionHeaders = document.querySelectorAll('.section-header');
            sectionHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const body = this.nextElementSibling;
                    const icon = this.querySelector('i');
                    
                    if (body.classList.contains('active')) {
                        body.classList.remove('active');
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    } else {
                        body.classList.add('active');
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                });
            });
            
            // Ouvrir la première section par défaut
            if (sectionHeaders.length > 0) {
                sectionHeaders[0].click();
            }
        }
        
        // Génération de PDF
        function generatePDF() {
            alert("Cette fonctionnalité permettrait de télécharger un PDF du résumé du questionnaire dans la version complète de l'application.");
            // Dans une version réelle, nous utiliserions une bibliothèque comme jsPDF ou html2pdf
        }
    </script>
</body>
</html>